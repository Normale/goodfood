# GoodFood Database Integration

This document describes the PostgreSQL database integration with pgvector extension for the GoodFood nutrition tracking application.

## Overview

The database stores:
- **Users**: User accounts (currently using a default user)
- **Ingredients**: Cached nutrition data for common ingredients
- **User Foods**: User's personal food library (created, edited, or copied)
- **Food Logs**: History of consumed foods

## Database Schema

### Tables

#### `users`
- `id` (UUID, primary key)
- `username` (text, unique)
- `email` (text, unique, nullable)
- `created_at` (timestamp)

#### `ingredients`
- `id` (UUID, primary key)
- `name` (text)
- `description` (text, nullable)
- `reasoning` (text, nullable) - AI reasoning about the ingredient
- 60 nutrient fields (see Nutrients section below)
- `updated_at` (timestamp)

#### `user_foods`
- `id` (UUID, primary key)
- `user_id` (UUID, foreign key → users)
- `source` (text, nullable) - e.g., "openfoodfacts", "usda"
- `source_key` (text, nullable) - reference key in source system
- `name` (text)
- `description` (text, nullable)
- 60 nutrient fields (see Nutrients section below)
- `vector_nutrition` (vector(60)) - normalized nutrition vector
- `vector_description` (vector(384)) - description embedding (placeholder)
- `updated_at` (timestamp)

#### `food_logs`
- `id` (UUID, primary key)
- `user_id` (UUID, foreign key → users)
- `user_food_id` (UUID, foreign key → user_foods)
- `eaten_at` (timestamp)
- `amount_grams` (numeric, nullable)
- `meal_type` (text, nullable) - breakfast, lunch, dinner, snack
- `extra` (jsonb, nullable) - extra metadata

### Nutrients (60 fields)

All tables with nutrition data include these fields:

**Macronutrients (10)**:
- calories, carbohydrates, protein, total_fats
- alpha_linolenic_acid, linoleic_acid, epa_dha
- soluble_fiber, insoluble_fiber, water

**Vitamins (13)**:
- vitamin_c, vitamin_a, vitamin_d, vitamin_e, vitamin_k
- vitamin_b1_thiamine, vitamin_b2_riboflavin, vitamin_b3_niacin
- vitamin_b5_pantothenic_acid, vitamin_b6_pyridoxine
- vitamin_b7_biotin, vitamin_b9_folate, vitamin_b12

**Minerals (14)**:
- calcium, phosphorus, magnesium, potassium, sodium, chloride
- iron, zinc, copper, selenium, manganese, iodine, chromium, molybdenum

**Amino Acids (9)**:
- leucine, lysine, valine, isoleucine, threonine
- methionine, phenylalanine, histidine, tryptophan

**Beneficial Compounds (6)**:
- choline, taurine, coq10, alpha_lipoic_acid, beta_glucan, resistant_starch

**Phytonutrients (9)**:
- beta_carotene, lycopene, lutein, zeaxanthin
- total_polyphenols, quercetin, sulforaphane, allicin, curcumin

## Vector Features

### Nutrition Vector (60 dimensions)

The `vector_nutrition` field is **automatically generated by PostgreSQL triggers** on insert/update:

1. Collects all 60 nutrient values
2. Normalizes by calories (divides each value by calories)
3. Stores as a 60-dimensional vector

**Use cases**:
- Find foods with similar nutritional profiles
- Recommend foods to fill nutritional gaps
- Exact nearest neighbor search using L2 distance

**Index**: HNSW index with `m=16, ef_construction=64`

### Description Vector (384 dimensions)

The `vector_description` field is a **placeholder for future implementation**:

- Will store text embeddings of food descriptions
- Intended for semantic search (e.g., "high protein breakfast")
- Uses cosine distance for similarity

**Index**: HNSW index with `m=16, ef_construction=64`

## Setup

### 1. Environment Variables

Add to your `.env` file:

```bash
DATABASE_URL=postgresql://goodfood:goodfood_dev@localhost:5432/goodfood
```

### 2. Start PostgreSQL (Docker)

```bash
docker-compose up postgres
```

This starts PostgreSQL 16 with pgvector extension.

### 3. Run Application

The application automatically:
1. Initializes database connection on startup
2. Runs migrations if tables don't exist
3. Creates the default user
4. Closes connections on shutdown

```bash
docker-compose up
```

## Usage

### Database Integration Module

Located at `backend/integrations/database.py`, provides:

```python
from integrations.database import (
    init_database,
    close_database,
    get_default_user,
    create_user_food,
    log_food,
    get_food_logs_by_date_range,
    search_user_foods_by_name,
)

# Initialize (called automatically on app startup)
await init_database()

# Create a food
user_food = await create_user_food(
    name="Grilled Chicken Breast",
    description="200g grilled chicken",
    nutrients={
        "calories": 330,
        "protein": 62,
        "carbohydrates": 0,
        "total_fats": 7.2,
        # ... other nutrients
    }
)

# Log food consumption
food_log = await log_food(
    user_food_id=user_food.id,
    amount_grams=200,
    meal_type="lunch"
)

# Get today's meals
from datetime import datetime, timedelta
now = datetime.now()
start = datetime(now.year, now.month, now.day)
end = start + timedelta(days=1)
logs = await get_food_logs_by_date_range(start, end)

# Search foods
foods = await search_user_foods_by_name("chicken")
```

### Default User

The system uses a default user (UUID: `00000000-0000-0000-0000-000000000000`) for all operations until authentication is implemented.

## Migrations

Migrations are stored in `backend/migrations/` as SQL files:

- `001_initial_schema.sql` - Initial schema with tables, triggers, indexes

The migration system:
1. Checks if tables exist on startup
2. Runs migration SQL if tables don't exist
3. Skips migration if tables already exist

## PostgreSQL Triggers

### Nutrition Vector Trigger

Automatically updates `vector_nutrition` on every insert/update to `user_foods`:

```sql
CREATE TRIGGER user_foods_nutrition_vector_trigger
BEFORE INSERT OR UPDATE ON user_foods
FOR EACH ROW
EXECUTE FUNCTION update_nutrition_vector();
```

The trigger:
1. Collects all 60 nutrient values into an array
2. Normalizes by calories (avoids division by zero)
3. Creates a 60-dimensional vector
4. Stores in `vector_nutrition` field

## Indexes

### B-tree Indexes (fast lookups)
- `idx_ingredients_name` - ingredient name
- `idx_user_foods_user_id` - user foods by user
- `idx_user_foods_source` - source + source_key
- `idx_food_logs_user_id` - food logs by user
- `idx_food_logs_eaten_at` - food logs by date
- `idx_food_logs_meal_type` - food logs by meal type

### HNSW Vector Indexes (similarity search)
- `idx_user_foods_nutrition_vector` - L2 distance for nutrition similarity
- `idx_user_foods_description_vector` - Cosine distance for semantic search

## Future Enhancements

1. **User Authentication**: Replace default user with proper auth system
2. **Description Embeddings**: Implement embedding generation for semantic search
3. **Ingredient Caching**: Populate `ingredients` table with common foods
4. **Source Integrations**: Add `source` and `source_key` for OpenFoodFacts, USDA
5. **Vector Search API**: Add endpoints for similarity-based food recommendations
6. **Analytics**: Add queries for nutritional trends and insights

## Troubleshooting

### Database connection issues

Check that PostgreSQL is running:
```bash
docker-compose ps postgres
```

### Migration not running

Manually run migration:
```bash
docker-compose exec postgres psql -U goodfood -d goodfood -f /path/to/migration.sql
```

### Vector extension not available

Ensure using `pgvector/pgvector:pg16` image in docker-compose.

### Check table structure

```bash
docker-compose exec postgres psql -U goodfood -d goodfood -c "\d user_foods"
```
